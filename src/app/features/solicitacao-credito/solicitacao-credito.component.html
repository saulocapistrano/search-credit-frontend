@if (!canAccess) {
  <div class="container mt-4">
    <div class="alert alert-warning">
      <strong>Acesso Negado:</strong> Você não tem permissão para acessar esta página.
    </div>
  </div>
} @else {
  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <h2 class="mb-4">Solicitação de Crédito</h2>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Dados da Solicitação</h5>
            <small class="text-muted">Status: <strong>EM_ANALISE</strong></small>
          </div>
          <div class="card-body">
            @if (isLoadingNumbers) {
              <div class="text-center mb-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
                <span class="ms-2">Carregando números sequenciais...</span>
              </div>
            }

            <form [formGroup]="solicitacaoForm" (ngSubmit)="onSubmit()">
              <div class="row">
                <!-- Número do Crédito (Readonly) -->
                <div class="col-md-6 mb-3">
                  <label for="numeroCredito" class="form-label">
                    Número do Crédito <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('numeroCredito')"
                    id="numeroCredito"
                    formControlName="numeroCredito"
                    readonly>
                  @if (isFieldInvalid('numeroCredito')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('numeroCredito') }}
                    </div>
                  }
                </div>

                <!-- Número NFSe (Readonly) -->
                <div class="col-md-6 mb-3">
                  <label for="numeroNfse" class="form-label">
                    Número NFSe <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('numeroNfse')"
                    id="numeroNfse"
                    formControlName="numeroNfse"
                    readonly>
                  @if (isFieldInvalid('numeroNfse')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('numeroNfse') }}
                    </div>
                  }
                </div>

                <!-- Data de Constituição -->
                <div class="col-md-6 mb-3">
                  <label for="dataConstituicao" class="form-label">
                    Data de Constituição <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('dataConstituicao')"
                    id="dataConstituicao"
                    formControlName="dataConstituicao">
                  @if (isFieldInvalid('dataConstituicao')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('dataConstituicao') }}
                    </div>
                  }
                </div>

                <!-- Valor ISSQN (Select) -->
                <div class="col-md-6 mb-3">
                  <label for="valorIssqn" class="form-label">
                    Valor ISSQN <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    [class.is-invalid]="isFieldInvalid('valorIssqn')"
                    id="valorIssqn"
                    formControlName="valorIssqn">
                    <option value="">Selecione um valor</option>
                    @for (valor of valorIssqnOptions; track valor) {
                      <option [value]="valor">{{ valor | number:'1.2-2' }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('valorIssqn')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('valorIssqn') }}
                    </div>
                  }
                </div>

                <!-- Tipo de Crédito (Select) -->
                <div class="col-md-6 mb-3">
                  <label for="tipoCredito" class="form-label">
                    Tipo de Crédito <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    [class.is-invalid]="isFieldInvalid('tipoCredito')"
                    id="tipoCredito"
                    formControlName="tipoCredito">
                    @for (tipo of tipoCreditoOptions; track tipo) {
                      <option [value]="tipo">{{ tipo }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('tipoCredito')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('tipoCredito') }}
                    </div>
                  }
                </div>

                <!-- Simples Nacional -->
                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    Simples Nacional <span class="text-danger">*</span>
                  </label>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      id="simplesNacionalSim"
                      formControlName="simplesNacional"
                      value="Sim">
                    <label class="form-check-label" for="simplesNacionalSim">
                      Sim
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      id="simplesNacionalNao"
                      formControlName="simplesNacional"
                      value="Não">
                    <label class="form-check-label" for="simplesNacionalNao">
                      Não
                    </label>
                  </div>
                  @if (isFieldInvalid('simplesNacional')) {
                    <div class="text-danger small">
                      {{ getFieldError('simplesNacional') }}
                    </div>
                  }
                </div>

                <!-- Alíquota (Select) -->
                <div class="col-md-6 mb-3">
                  <label for="aliquota" class="form-label">
                    Alíquota (%) <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    [class.is-invalid]="isFieldInvalid('aliquota')"
                    id="aliquota"
                    formControlName="aliquota">
                    <option value="">Selecione uma alíquota</option>
                    @for (aliquota of aliquotaOptions; track aliquota) {
                      <option [value]="aliquota">{{ aliquota }}%</option>
                    }
                  </select>
                  @if (isFieldInvalid('aliquota')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('aliquota') }}
                    </div>
                  }
                </div>

                <!-- Valor Faturado -->
                <div class="col-md-6 mb-3">
                  <label for="valorFaturado" class="form-label">
                    Valor Faturado <span class="text-danger">*</span>
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('valorFaturado')"
                    id="valorFaturado"
                    formControlName="valorFaturado"
                    placeholder="0.00">
                  @if (isFieldInvalid('valorFaturado')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('valorFaturado') }}
                    </div>
                  }
                </div>

                <!-- Valor de Dedução (Readonly - Calculado) -->
                <div class="col-md-6 mb-3">
                  <label for="valorDeducao" class="form-label">
                    Valor de Dedução <span class="text-danger">*</span>
                    <small class="text-muted">(calculado automaticamente - 15%)</small>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('valorDeducao')"
                    id="valorDeducao"
                    formControlName="valorDeducao"
                    readonly>
                  @if (isFieldInvalid('valorDeducao')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('valorDeducao') }}
                    </div>
                  }
                </div>

                <!-- Base de Cálculo (Select) -->
                <div class="col-md-6 mb-3">
                  <label for="baseCalculo" class="form-label">
                    Base de Cálculo <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    [class.is-invalid]="isFieldInvalid('baseCalculo')"
                    id="baseCalculo"
                    formControlName="baseCalculo">
                    <option value="">Selecione uma base de cálculo</option>
                    @for (base of baseCalculoOptions; track base) {
                      <option [value]="base">{{ base | number:'1.2-2' }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('baseCalculo')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('baseCalculo') }}
                    </div>
                  }
                </div>

                <!-- Nome do Solicitante -->
                <div class="col-md-12 mb-3">
                  <label for="nomeSolicitante" class="form-label">
                    Nome do Solicitante <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('nomeSolicitante')"
                    id="nomeSolicitante"
                    formControlName="nomeSolicitante"
                    placeholder="Digite o nome completo do solicitante">
                  @if (isFieldInvalid('nomeSolicitante')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('nomeSolicitante') }}
                    </div>
                  }
                </div>

                <!-- Comprovante de Renda -->
                <div class="col-md-12 mb-3">
                  <label for="comprovanteRenda" class="form-label">
                    Comprovante de Renda <span class="text-danger">*</span>
                  </label>
                  <input
                    type="file"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('comprovanteRenda')"
                    id="comprovanteRenda"
                    accept=".pdf,.jpg,.jpeg,.png"
                    (change)="onFileSelected($event)">
                  @if (isFieldInvalid('comprovanteRenda')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('comprovanteRenda') }}
                    </div>
                  }
                  <small class="form-text text-muted">
                    Formatos aceitos: PDF, JPG, PNG. Tamanho máximo: 5MB
                  </small>
                  @if (fileName) {
                    <div class="mt-2">
                      <span class="badge bg-info">
                        <i class="fas fa-file"></i> {{ fileName }}
                      </span>
                    </div>
                  }
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-4">
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="resetForm()"
                  [disabled]="isLoading">
                  Limpar
                </button>
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="solicitacaoForm.invalid || !comprovanteFile || isLoading || isLoadingNumbers">
                  @if (isLoading) {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Enviando...
                  } @else {
                    Enviar Solicitação
                  }
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
}
